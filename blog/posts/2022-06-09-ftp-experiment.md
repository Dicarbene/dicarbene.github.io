---
layout: Post
title: FTP 实验
subtitle: 在 Linux 系统上使用 Socket 编程技术实现简化的 FTP 服务器和客户端的程序。
author: dicarbene
date: 2022-06-09
useHeaderImage: true
headerImage: /img/in-post/2022-06-05/7.png
headerMask: rgb(67, 65, 47, .4)
permalinkPattern: /post/:year/:month/:day/:slug/
tags:
  - 实验
  - 课设
---

## TCP 复习

[参见此处](/post/2022/05/23/Computer-Networks/)
credit: 感谢[zxh dalao](https://note.zxh.io)

## 实验内容

本实验要求学生在 Linux 系统上使用 C/C++编程语言利用 Socket 接口实现 FTP 客户端和服务器的程序，使客户端可以连接至服务器，并且可以进行一些 FTP 的基本操作，如列出目录、下载文件等。

### 实验说明

FTP 是 File Transfer Protocol 的简称，即文件传输协议的缩写。该协议用于在两台计算机之间传送文件。FTP 会话包含了两个通道，一个是控制通道，一个是数据通道。控制通道是和 FTP 服务器进行沟通的通道，连接 FTP 服务器，发送 FTP 指令；数据通道则是和 FTP 服务器进行文件传输或者获取文件列表的通道。

FTP 中，控制连接的各种指令均由客户端主动发起，而数据连接有两种工作方式：主动方式（PORT 方式）和被动方式（PASV 方式）。主动方式下，FTP 客户端首先和 FTP 服务器的控制通道对应端口（一般为 21）建立连接，通过控制通道发送命令，客户端需要接收数据的时候在这个通道上发送 PORT 命令。PORT 命令包含了客户端用什么端口（一个大于 1024 的端口）接收数据。在传输数据的时候，FTP 服务器必须和客户端建立一个新的连接。被动方式下，建立控制通道的过程和主动方式类似，当客户端通过这个通道发送 PASV 命令的时候，FTP Server 打开一个位于 1024 ～ 5000 之间的随机端口并且通知客户端，然后客户端与服务器之间将通过这个端口进行数据的传送。

具体的 FTP 规范请参考 RFC959。

**为方便起见, 本实验参考了[译文](https://github.com/comehope/rfc-translation/blob/master/rfc-959-cn.pdf)。**

### 实验内容

本实验要求学生在 Linux 系统上使用 C/C++编程语言利用 Socket 接口实现 FTP 客户端和服务器的程序，使客户端可以连接至服务器，并且可以进行一些 FTP 的基本操作，如列出目录、下载文件等。从 FTP 的实现角度来看，客户端与服务器的命令通道和数据通道需要分离，同时应该支持包括但不限于以下一些 FTP 命令：

1. get：取远方的一个文件。
2. put：传给远方一个文件。
3. pwd：显示远方当前目录。
4. dir：列出远方当前目录下的子目录和文件列表。
5. cd：改变远方当前目录。
6. ?：显示你提供的命令列表。
7. quit：退出返回。

### 思考问题

请在完成了 FTP 客户端与服务器程序之后，思考如下的问题：

1. 在 FTP 中，为什么要建立两个 TCP 连接来分别传送命令和数据？

   **如果共用同一个 TCP 连接, 传输数据时将会堵塞命令输入, 出现错误或误操作等情况将会造成问题**

2. 主动方式和被动方式的主要区别是什么？为何要设计这两种方式？

   **主动方式: 客户端主动向服务端建立连接**

   **被动方式: 客户端被动向服务端建立连接**

3. 当使用 FTP 下载大量小文件的时候，速度会很慢，这是什么缘故？可以怎样改进？

   **每次都要新建一个 TCP 连接, 建立与释放连接的时间超过了传输数据的时间**

   **改进方法: 建立连接池/端口池, 固定地从池内取用放回, 避免出现巨量的建立或释放连接时间影响效率**

## 使用到的 RFC959 标准

### 指令

```bash
ls      pwd     cd      get     put
user    dir     quit    exit    bye
ftp     ?
```

### Server回应码 (按数字顺序排序)

```bash
110 重新开始标记应答。在这种情况下文本是确定的，它必须读取：MARK yyyy=mmmm
    其中yyyy是用户进程数据流标记，mmmm是服务器等价的标记（注意，两个标记之间用"="连接）。
120 服务在nnn分钟内准备好。
125 数据连接已经打开，传输开始。
150 文件状态正确；关于建立数据连接。
200 指令成功。
202 指令未执行，对这个站点来说是不必要的。
211 系统状态，或系统帮助回应。
212 目录状态。
213 文件状态。
214 帮助消息。如何使用服务器或一个不标准的指令的特殊含义。该回应只对人类用户有用。
215 名字系统类型 该名字是编号分配文档里列出的正式系统名。
220 服务为新用户准备好。
221 服务关闭控制连接。适当时退出。
225 数据连接打开，没有传输进行。
226 关闭数据连接。请求的文件操作成功（比如，文件传输或文件终止）。
227 进入被动模式（h1,h2,h3,h4,p1,p2）。
230 用户登录，继续。
250 请求的文件操作正确，完成。
257 “路径名”已建立。
331 用户名正确，需要口令。
332 需要登录帐户。
350 请求的文件操作需要更多的信息。
421 服务无效，关闭控制连接。当服务知道必须关机时对任何指令做出的回应。
425 不能建立数据连接。
426 连接关闭；传输终止。
450 请求的文件操作没有执行。文件无效（比如，文件忙）。
451 请求操作终止。进程发生局部错误。
452 请求操作没有执行。系统存储空间不足。
500 语法错误，未被承认的指令。它包含像指令行太多这样的错误。
501 因参数或变量导致的语法错误。
502 指令未执行。
503 错误的指令顺序。
504 指令因参数的原因没有执行。
530 没有登录。
532 需要存储文件的帐户。
550 请求的操作没有执行。文件无效（比如，文件没找到，没有权限）。
551 请求操作终止。页类型未知。
552 请求的文件操作终止。超出可分配的存储空间（对当前目录或数据集来说）。
553 请求的操作没有执行。
```
